# 深入理解计算机系统

## 计算机系统漫游
- 编译过程
<img width="739" height="138" alt="image" src="https://github.com/user-attachments/assets/f4559e90-b432-474c-b69f-14e29d6666f0" />

- 系统硬件组成
<img width="635" height="387" alt="image" src="https://github.com/user-attachments/assets/bf07d4f2-0f61-48b3-a010-f5842ee834e0" />

- CPU指令操作
<img width="1536" height="1024" alt="ChatGPT Image 2025年12月18日 13_54_05" src="https://github.com/user-attachments/assets/600b0df5-1380-4d4c-a3fa-2a89678b6c39" />

- 运行程序
<img width="582" height="401" alt="image" src="https://github.com/user-attachments/assets/9ef5faf0-dcc1-4561-a2fc-37d6e1f0245e" />
<img width="647" height="412" alt="image" src="https://github.com/user-attachments/assets/8551809a-8ff7-4522-b35f-a0a8faefaba8" />
<img width="615" height="411" alt="image" src="https://github.com/user-attachments/assets/1c5bd145-ea25-411e-a87b-cc06b454d605" />

- 高速缓存
<img width="573" height="226" alt="image" src="https://github.com/user-attachments/assets/530d7240-4b1e-4e5a-96c6-7b8317dac49e" />

- 存储设备形成层次结构
<img width="719" height="411" alt="image" src="https://github.com/user-attachments/assets/50277ddb-adff-4a19-84d1-da927b8f4b31" />

- 进程
<img width="746" height="297" alt="image" src="https://github.com/user-attachments/assets/907a9d5c-d954-4a7c-baa4-23e7adf1ae26" />

- 线程
进程是资源的拥有者，线程是 CPU 调度与执行的基本单位。  
一个进程里可以有多个线程，这些线程共享进程的资源，但各自有独立的执行上下文。  
- 虚拟内存

- 文件
文件就是字节序列，仅此而已。
- Amdahl定律
当我们对系统的某个部分加速时，其对系统整体性能的影响取决于该部分的重要
性和加速程度。
- 并发和并行
线程级并行、指令集并行、单指令多数据并行。
- 

## 程序结构和执行

### 信息的表示和处理
- 信息存储
进制，有无符号，字数据大小，寻址方式（大小端），字符串，
- 整数表示
- 整数运算
- 浮点数

### 程序的机器级表示

- 历史观点
Inter和AMD
- 程序编码
机器级代码  
高级语言-汇编语言-目标代码

- 数据格式
字（word）表示16bits 双字表示32bits

- 访问信息
通用目的寄存器，操作数指示符，数据传送指示符。。。
- 算数和逻辑操作
- 控制
if/switch
- 过程
- 数组分配和访问
- 异数的数据结构
- 在机器级程序中将控制与数据结合起来
- 浮点代码


### 处理器体系结构

- Y86-64指令集体系结构
<img width="378" height="357" alt="image" src="https://github.com/user-attachments/assets/1461d4c7-7f28-4f5a-8731-10ecb1395e03" />

- HCL

- Y86-64的顺序实现
取指-译码-执行-访存-写回-更新PC
<img width="793" height="412" alt="image" src="https://github.com/user-attachments/assets/9edb6fce-e909-4d6d-941c-85951cbbab69" />
<img width="902" height="957" alt="image" src="https://github.com/user-attachments/assets/c524e195-6059-4c9f-bda9-b60a22253dbc" />

- 流水线的通用原理
<img width="363" height="205" alt="image" src="https://github.com/user-attachments/assets/d37d989e-a2f4-4da0-b289-1c79cecdb5d1" />
局限性：1.不一致的划分 2.流水线过深，收益反而下降，因为随着阶数增加流水线延迟会增加。
- Y86-64的流水线实现

### 优化程序性能

- 消除循环的低效率
- 减少过程调用
- 消除不必要的内存引用
- 理解现代处理器
取指令-预测分支-正确-清空退役-下一条
              -错误-丢弃退役-下一条
- 循环展开
- 提高并行性
- 

### 存储器层次结构

- RAM（随机访问存储器）
易失性，有电就行

|SRAM（静态）|DRAM（动态）|  
|:---:|:---:|  
|双稳态|电容充电|  
|更快|较快|

- 非易失性存储器
ROM,PROM,EEPROM,flash,
- 访问主存
<img width="682" height="334" alt="image" src="https://github.com/user-attachments/assets/cb86eee8-0f5b-4c47-a8e3-a4b99a70a957" />

- 局部性
时间局部性和空间局部性
- 存储器的层次结构
<img width="998" height="603" alt="image" src="https://github.com/user-attachments/assets/a046ee22-43aa-485c-914d-4043c73a4300" />

- 高速缓存存储器
其实就是比DRAM更快比寄存器慢的SRAM
- 


## 在系统上运行程序

### 链接
链接(linking)是将各种代码和数据片段收集并组合成为一个单一文件的过程，这个文件可被加载（复制）到内存并执行。  

- 编译器驱动程序
语言预处理器-编译器-汇编器-链接器  
编译器翻译产生ASCII 汇编语言文件main.s  
汇编器翻译产生可重定位目标文件（relo-catable object file)main.o  
- 静态链接
符号解析--重定位
- 目标文件
可重定位目标文件--可执行目标文件--共享目标文件
- 可重定位目标文件
包含二进制代码和数据，其形式可以在编译时与其他可重定位目标文件合并起来，创建一个可执行目标文件。
<img width="390" height="395" alt="image" src="https://github.com/user-attachments/assets/0ae6f898-cf70-4b33-b3ef-6bf943135305" />

- 符号和符号表
只定义全局符号-被引用全局符号-只定义和被引用的局部符号  
- 符号解析
全局符号解析很棘手，同名，找不到等问题。
- 重定位
重定位节和符号定义--重定位节中的符号引用
- 可执行目标文件
<img width="697" height="456" alt="image" src="https://github.com/user-attachments/assets/04798bbe-02b5-4341-858c-518c3fc09b4e" />

- 加载可执行目标文件
加载器将可执行目标文件中的代码和数据从磁盘复制到内存中，然后跳转第一条指令启动
-  动态链接库
共享库，可以加载到任意内存地址，任意程序链接。（.so/linux .dll/windows）  

-  从应用程序中加载和链接共享库
#include <.h>
- 位置无关码
可以加载而无需重定位的代码称为位置无关代码（Position-Independent Code, PIC)。用户对GCC 使用-fpic 选项指示GNU 编译系统生成PIC 代码。共享库的编译必须总是使用该选项。
- 库打桩机制

- 处理目标文件的工具
AR,STRUBGS,STRIP,NM,OBJDUMP。。。

### 异常控制流（Exceptional Control Flow, ECF）

- 异常
<img width="522" height="414" alt="image" src="https://github.com/user-attachments/assets/7cbc0926-9ef1-4cf8-9add-a782a873e246" />
异常的类别
<img width="837" height="236" alt="image" src="https://github.com/user-attachments/assets/3bdd0398-5faf-4ccb-b6d8-75c0864d6b01" />

- 进程
假象--程序独占处理器和内存系统  
实际是有好多进程一起
<img width="487" height="243" alt="image" src="https://github.com/user-attachments/assets/c90e2031-e76d-4ae5-9eb5-d2ab56c24e89" />
并发流：  
A在B开始后结束前开始。
私有空间地址：
对于每个进程，都有自己的私有地址空间。但是每个进程的地址空间的结构是相同的。
用户模式（root）和内核模式：
上下文切换：
<img width="832" height="345" alt="image" src="https://github.com/user-attachments/assets/6d8cc5f6-c5c3-4a8c-8bcf-2b16b019b874" />

- 系统调用错误处理
错误返回 -1
- 进程控制
创建进程ID-创建和终止进程-回收子进程-让进程休眠-加载并运行程序
- 信号
软件形式，允许进程和内核中断其他进程
发送与接受
- 非本地跳转
用户级，
- 操作进程的工具
STRACE/PS/TOP/PMAP
- 

### 虚拟内存

- 物理和虚拟寻址
<img width="581" height="298" alt="image" src="https://github.com/user-attachments/assets/ef468343-1b27-47de-a620-aa7793f86c45" />

- 地址空间
虚拟地址空间（32位和64位）和物理地址空间
- 虚拟内存作为缓存的工具
<img width="522" height="253" alt="image" src="https://github.com/user-attachments/assets/e00e7358-5c6b-4c43-b79c-0359e13b2d54" />
页表：虚拟地址翻译为物理地址
<img width="443" height="336" alt="image" src="https://github.com/user-attachments/assets/1f09e9c5-cf55-4df2-9efa-2372de656a8d" />
已分配虚拟-页表-分配到物理
未命中称为缺页

- 虚拟内存作为内存管理的工具
<img width="405" height="283" alt="image" src="https://github.com/user-attachments/assets/a63a89e5-064c-4f6c-b5c8-2d84e478a11e" />

- 虚拟内存作为内存保护的工具
<img width="674" height="334" alt="image" src="https://github.com/user-attachments/assets/88d50403-4bc0-44c1-af56-2c032c60c64f" />

- 地址翻译

- 内存映射

- 动态内存分配

- 垃圾收集

- C语言中常见的与内存有关的错误

## 程序间的交流和通信

### 系统级I/O

- Unix I/O
打开文件-shell三文件-改变当前文件位置-读写文件
- 文件

- 打开和关闭文件

- 读写文件

- 用RIO包健壮地读写
- 读取文件元数据
- 读取目录和内容
- 共享文件
- I/O重定向

- 标准I/O
库
- 

### 网络编程

- 客户端-服务器编程模型
<img width="620" height="128" alt="image" src="https://github.com/user-attachments/assets/35fe1576-b998-4651-aed4-6d9d7fe35e9c" />

- 网络
以太网
- 因特网
TCP/IP协议
- 套接字接口
<img width="699" height="448" alt="image" src="https://github.com/user-attachments/assets/80955f26-2189-419d-ac38-fbd9fa5668fa" />

- web服务器
HTTP协议-
- 

### 并发

- 基于进程的并发编程
<img width="722" height="207" alt="image" src="https://github.com/user-attachments/assets/5bc03d3b-01f8-4547-9232-4f6fa2f1fa04" />
<img width="646" height="246" alt="image" src="https://github.com/user-attachments/assets/fc959ff8-6575-4010-8b4b-d84f2e6beeec" />

- 基于I/O多路复用的并发编程

- 基于线程的并发编程
<img width="386" height="299" alt="image" src="https://github.com/user-attachments/assets/6782e665-83b9-4c36-a918-3d35f566ceed" />

- 多线程程序中的共享变量

- 用信号量同步线程

- 使用线程提高并行性
<img width="342" height="193" alt="image" src="https://github.com/user-attachments/assets/7eb30b79-05bf-4c00-9bdc-32610d718a44" />




































